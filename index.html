<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>Vigilance M√©t√©o Canada - Flux Complet</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <style>
      :root {
        --sidebar-width: 350px;
        --primary: #1a1a1a;
      }
      body,
      html {
        margin: 0;
        padding: 0;
        height: 100%;
        font-family: "Segoe UI", sans-serif;
        background: #eee;
        overflow: hidden;
      }
      .container {
        display: flex;
        flex-direction: column;
        height: 100vh;
      }
      header {
        height: 60px;
        background: var(--primary);
        color: white;
        display: flex;
        align-items: center;
        padding: 0 20px;
        z-index: 1001;
      }
      .main-content {
        display: flex;
        flex: 1;
        overflow: hidden;
      }
      #sidebar {
        width: var(--sidebar-width);
        background: white;
        border-right: 1px solid #ddd;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
      }
      #map {
        flex: 1;
        height: 100%;
        width: 100%;
      }
      .sidebar-section {
        padding: 15px;
        border-bottom: 1px solid #eee;
      }
      .alert-card {
        padding: 12px;
        border-bottom: 1px solid #f0f0f0;
        cursor: pointer;
        display: flex;
        border-left: 6px solid transparent;
      }
      .alert-card:hover {
        background: #f8f9fa;
      }
      #loader {
        position: fixed;
        top: 75px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 2000;
        background: white;
        padding: 10px 20px;
        border-radius: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        font-weight: bold;
      }
      .dot {
        height: 10px;
        width: 10px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header><h2>üá®üá¶ Vigilance M√©t√©o (Flux SMC Officiel)</h2></header>
      <div class="main-content">
        <div id="sidebar">
          <div class="sidebar-section">
            <h3>L√©gende</h3>
            <div>
              <span class="dot" style="background: #e74c3c"></span>
              Avertissement
            </div>
            <div>
              <span class="dot" style="background: #e67e22"></span> Veille
            </div>
            <div>
              <span class="dot" style="background: #f1c40f"></span> Avis
            </div>
            <div>
              <span class="dot" style="background: #95a5a6"></span> Bulletin
              sp√©cial
            </div>
          </div>
          <div class="sidebar-section" style="flex: 1">
            <h3 id="alert-status">Chargement...</h3>
            <div id="alert-list"></div>
          </div>
        </div>
        <div id="map"></div>
      </div>
    </div>
    <div id="loader">R√©cup√©ration des donn√©es SMC...</div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
      // 1. Initialize the map first!
      const map = L.map("map").setView([58, -95], 4);
      L.tileLayer(
        "https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png",
        {
          attribution: "¬© OpenStreetMap | Donn√©es SMC/ECCC",
        }
      ).addTo(map);

      function getColor(colour) {
        const colors = {
          red: "#e74c3c",
          orange: "#e67e22",
          yellow: "#f1c40f",
          grey: "#95a5a6",
        };
        return colors[colour] || "#3498db";
      }

      // 2. The function to call your backend
      async function loadData() {
        const targetUrl = "https://nqy5nf-5000.csb.app/api/alerts"; // This points to your Node server

        try {
          const response = await fetch(targetUrl);
          if (!response.ok) throw new Error("Erreur serveur");

          const data = await response.json();
          const globalAlerts = data.alerts || {};

          document.getElementById("loader").style.display = "none";
          const listContainer = document.getElementById("alert-list");
          listContainer.innerHTML = "";

          L.geoJSON(data, {
            style: (f) => {
              const alert = globalAlerts[f.properties.alerts?.[0]?.alertRef];
              return {
                fillColor: getColor(alert?.colour),
                weight: 1,
                color: "white",
                fillOpacity: 0.5,
              };
            },
            onEachFeature: (feature, layer) => {
              const alert =
                globalAlerts[feature.properties.alerts?.[0]?.alertRef];
              if (alert) {
                layer.bindPopup(
                  `<b>${alert.alertBannerText}</b><br>${feature.properties.name}`
                );

                const card = document.createElement("div");
                card.className = "alert-card";
                card.style.borderLeftColor = getColor(alert.colour);
                card.innerHTML = `<div><strong>${alert.alertNameShort}</strong><br><small>${feature.properties.name}</small></div>`;
                card.onclick = () => {
                  map.fitBounds(layer.getBounds());
                  layer.openPopup();
                };
                listContainer.appendChild(card);
              }
            },
          }).addTo(map);

          document.getElementById(
            "alert-status"
          ).innerText = `${data.features.length} bulletins actifs`;
        } catch (error) {
          console.error("Erreur back-end:", error);
          document.getElementById(
            "loader"
          ).innerHTML = `<span style="color:red">Erreur : Serveur indisponible</span>`;
        }
      }

      // 3. Run the function
      loadData();
    </script>
  </body>
</html>
